// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ==================== USERS & AUTH ====================

model users {
  id            BigInt       @id @default(autoincrement()) @db.UnsignedBigInt
  username      String       @unique @db.VarChar(50)
  email         String       @unique @db.VarChar(255)
  password_hash String?      @db.VarChar(255)
  full_name     String?      @db.VarChar(200)
  phone         String?      @db.VarChar(30)
  google_id     String?      @unique @db.VarChar(255)
  avatar_url    String?      @db.VarChar(1000)
  role          String       @default("customer") @db.VarChar(100)
  status        users_status @default(active)
  
  // 2FA Fields
  two_factor_enabled Boolean      @default(false) @db.TinyInt
  two_factor_otp     String?      @db.VarChar(10)
  two_factor_expires DateTime?
  
  // Address fields (Main Profile Address - Kept for backward compatibility)
  address_line1 String?      @db.VarChar(255)
  address_line2 String?      @db.VarChar(255)
  city          String?      @db.VarChar(120)
  province      String?      @db.VarChar(120)
  country       String?      @db.VarChar(50) @default("VN")
  
  created_at    DateTime     @default(now())
  updated_at    DateTime?    @updatedAt

  carts              carts[]
  orders             orders[]
  wishlists          wishlists[]
  coupon_redemptions coupon_redemptions[]
  notifications      notifications[]
  activity_logs      activity_logs[]
  shipping_addresses shipping_addresses[]
  conversations      conversations[]
  
  role_def           permissions @relation(fields: [role], references: [name])

  @@index([role], map: "idx_users_role")
}


enum users_status {
  active
  blocked
}

// ==================== SHIPPING ADDRESSES ====================

model shipping_addresses {
  id            BigInt    @id @default(autoincrement()) @db.UnsignedBigInt
  user_id       BigInt    @db.UnsignedBigInt
  full_name     String    @db.VarChar(200)
  phone         String    @db.VarChar(30)
  address_line1 String    @db.VarChar(255)
  address_line2 String?   @db.VarChar(255)
  city          String    @db.VarChar(120)
  province      String    @db.VarChar(120)
  country       String    @default("VN") @db.VarChar(50)
  postal_code   String?   @db.VarChar(20)
  is_default    Boolean   @default(false) @db.TinyInt
  type          String    @default("Nhà riêng") @db.VarChar(50) // Nhà riêng, Văn phòng
  created_at    DateTime  @default(now())
  updated_at    DateTime? @updatedAt

  user          users     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id], map: "idx_addr_user")
}

// ==================== CATEGORIES ====================

model categories {
  id         BigInt    @id @default(autoincrement()) @db.UnsignedBigInt
  parent_id  BigInt?   @db.UnsignedBigInt
  name       String    @db.VarChar(200)
  slug       String    @unique @db.VarChar(220)
  is_active  Boolean   @default(true) @db.TinyInt
  sort_order Int       @default(0)
  created_at DateTime  @default(now())
  updated_at DateTime? @updatedAt

  parent           categories?        @relation("CategoryHierarchy", fields: [parent_id], references: [id], onDelete: SetNull)
  children         categories[]       @relation("CategoryHierarchy")
  products         products[]
  category_options category_options[]

  @@index([parent_id], map: "idx_categories_parent")
}

// ==================== PRODUCTS ====================

model products {
  id               BigInt    @id @default(autoincrement()) @db.UnsignedBigInt
  category_id      BigInt?   @db.UnsignedBigInt
  sku              String    @unique @db.VarChar(80)
  size             String?   @db.VarChar(50)
  name             String    @db.VarChar(255)
  slug             String    @unique @db.VarChar(270)
  description      String?   @db.LongText
  base_price       Decimal   @default(0.00) @db.Decimal(12, 2)
  compare_at_price Decimal?  @db.Decimal(12, 2)
  is_active        Boolean   @default(true) @db.TinyInt
  created_at       DateTime  @default(now())
  updated_at       DateTime? @updatedAt

  category categories? @relation(fields: [category_id], references: [id], onDelete: SetNull)
  brand    brands?     @relation(fields: [brand_id], references: [id], onDelete: SetNull)

  // SEO
  meta_title       String? @db.VarChar(255)
  meta_description String? @db.VarChar(500)
  meta_keywords    String? @db.VarChar(255)

  // Shipping
  weight Decimal? @default(0.00) @db.Decimal(10, 2) // grams
  length Decimal? @default(0.00) @db.Decimal(10, 2) // cm
  width  Decimal? @default(0.00) @db.Decimal(10, 2) // cm
  height Decimal? @default(0.00) @db.Decimal(10, 2) // cm

  // Financial
  cost_price Decimal? @default(0.00) @db.Decimal(12, 2)
  tax_rate   Decimal? @default(0.00) @db.Decimal(5, 2)

  // Organization
  brand_id BigInt? @db.UnsignedBigInt
  tags     String? @db.Text // JSON or comma separated

  product_variants    product_variants[]
  product_images      product_images[]
  product_attributes  product_attributes[]
  product_collections product_collections[]
  order_items         order_items[]
  wishlist_items      wishlist_items[]
  product_reviews     product_reviews[]

  @@index([category_id], map: "idx_products_category")
  @@index([brand_id], map: "idx_products_brand")
}

model product_variants {
  id               BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  product_id       BigInt   @db.UnsignedBigInt
  variant_sku      String   @unique @db.VarChar(120)
  price            Decimal  @default(0.00) @db.Decimal(12, 2)
  compare_at_price Decimal? @db.Decimal(12, 2)
  cost             Decimal? @db.Decimal(12, 2) // Profit calc per variant
  stock_qty        Int      @default(0)

  // Shipping Override
  weight Decimal? @db.Decimal(10, 2)
  length Decimal? @db.Decimal(10, 2)
  width  Decimal? @db.Decimal(10, 2)
  height Decimal? @db.Decimal(10, 2)

  // Media
  image_url String? @db.VarChar(1000)

  is_active  Boolean   @default(true) @db.TinyInt
  created_at DateTime  @default(now())
  updated_at DateTime? @updatedAt

  product               products                @relation(fields: [product_id], references: [id], onDelete: Cascade)
  cart_items            cart_items[]
  order_items           order_items[]
  inventory_movements   inventory_movements[]
  variant_option_values variant_option_values[]
  product_images        product_images[] // Link specific images to this variant

  @@index([product_id], map: "idx_variants_product")
}

model product_images {
  id         BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  product_id BigInt   @db.UnsignedBigInt
  variant_id BigInt?  @db.UnsignedBigInt // Optional link to specific variant (e.g. Color Red)
  url        String   @db.VarChar(1000)
  alt_text   String?  @db.VarChar(255)
  is_primary Boolean  @default(false) @db.TinyInt
  sort_order Int      @default(0)
  created_at DateTime @default(now())

  product products          @relation(fields: [product_id], references: [id], onDelete: Cascade)
  variant product_variants? @relation(fields: [variant_id], references: [id], onDelete: SetNull)

  @@index([product_id], map: "idx_pi_product")
  @@index([variant_id], map: "idx_pi_variant")
}

model product_attributes {
  product_id      BigInt   @db.UnsignedBigInt
  option_id       BigInt   @db.UnsignedBigInt
  option_value_id BigInt   @db.UnsignedBigInt
  created_at      DateTime @default(now())

  product      products      @relation(fields: [product_id], references: [id], onDelete: Cascade)
  option       options       @relation(fields: [option_id], references: [id], onDelete: Cascade)
  option_value option_values @relation(fields: [option_value_id], references: [id], onDelete: Cascade)

  @@id([product_id, option_id])
  @@index([option_id], map: "idx_pa_option")
  @@index([option_value_id], map: "idx_pa_option_value")
}

// ==================== BRANDS & COLLECTIONS ====================

model brands {
  id          BigInt    @id @default(autoincrement()) @db.UnsignedBigInt
  name        String    @db.VarChar(200)
  slug        String    @unique @db.VarChar(220)
  logo        String?   @db.VarChar(1000)
  description String?   @db.Text
  is_active   Boolean   @default(true) @db.TinyInt
  created_at  DateTime  @default(now())
  updated_at  DateTime? @updatedAt

  products products[]
}

model collections {
  id          BigInt    @id @default(autoincrement()) @db.UnsignedBigInt
  name        String    @db.VarChar(200)
  slug        String    @unique @db.VarChar(220)
  image       String?   @db.VarChar(1000)
  description String?   @db.Text
  is_active   Boolean   @default(true) @db.TinyInt
  created_at  DateTime  @default(now())
  updated_at  DateTime? @updatedAt

  product_collections product_collections[]
}

model product_collections {
  product_id    BigInt @db.UnsignedBigInt
  collection_id BigInt @db.UnsignedBigInt

  product    products    @relation(fields: [product_id], references: [id], onDelete: Cascade)
  collection collections @relation(fields: [collection_id], references: [id], onDelete: Cascade)

  @@id([product_id, collection_id])
  @@index([collection_id], map: "idx_pc_collection")
}

// ==================== OPTIONS (Color, Size, etc.) ====================

model options {
  id   BigInt @id @default(autoincrement()) @db.UnsignedBigInt
  name String @db.VarChar(100)
  code String @unique @db.VarChar(50)

  option_values      option_values[]
  category_options   category_options[]
  product_attributes product_attributes[]
}

model option_values {
  id         BigInt @id @default(autoincrement()) @db.UnsignedBigInt
  option_id  BigInt @db.UnsignedBigInt
  value      String @db.VarChar(100)
  sort_order Int    @default(0)

  option                options                 @relation(fields: [option_id], references: [id], onDelete: Cascade)
  product_attributes    product_attributes[]
  variant_option_values variant_option_values[]

  @@unique([option_id, value], map: "uk_option_values")
  @@index([option_id], map: "idx_ov_option")
}

model variant_option_values {
  variant_id      BigInt @db.UnsignedBigInt
  option_value_id BigInt @db.UnsignedBigInt

  variant      product_variants @relation(fields: [variant_id], references: [id], onDelete: Cascade)
  option_value option_values    @relation(fields: [option_value_id], references: [id], onDelete: Cascade)

  @@id([variant_id, option_value_id])
  @@index([option_value_id], map: "idx_vov_value")
}

model category_options {
  category_id BigInt  @db.UnsignedBigInt
  option_id   BigInt  @db.UnsignedBigInt
  is_required Boolean @default(false) @db.TinyInt
  sort_order  Int     @default(0)

  category categories @relation(fields: [category_id], references: [id], onDelete: Cascade)
  option   options    @relation(fields: [option_id], references: [id], onDelete: Cascade)

  @@id([category_id, option_id])
  @@index([option_id], map: "idx_co_option")
}

// ==================== CART ====================

model carts {
  id         BigInt    @id @default(autoincrement()) @db.UnsignedBigInt
  user_id    BigInt?   @db.UnsignedBigInt
  session_id String?   @db.VarChar(128)
  created_at DateTime  @default(now())
  updated_at DateTime? @updatedAt

  user       users?       @relation(fields: [user_id], references: [id], onDelete: SetNull)
  cart_items cart_items[]

  @@index([user_id], map: "idx_carts_user")
  @@index([session_id], map: "idx_carts_session")
}

model cart_items {
  id           BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  cart_id      BigInt   @db.UnsignedBigInt
  variant_id   BigInt   @db.UnsignedBigInt
  qty          Int
  price_at_add Decimal  @db.Decimal(12, 2)
  created_at   DateTime @default(now())

  cart    carts            @relation(fields: [cart_id], references: [id], onDelete: Cascade)
  variant product_variants @relation(fields: [variant_id], references: [id])

  @@unique([cart_id, variant_id], map: "uk_cart_variant")
  @@index([cart_id], map: "idx_ci_cart")
  @@index([variant_id], map: "idx_ci_variant")
}

// ==================== ORDERS ====================

model orders {
  id                 BigInt        @id @default(autoincrement()) @db.UnsignedBigInt
  order_code         String        @unique @db.VarChar(30)
  user_id            BigInt?       @db.UnsignedBigInt
  status             orders_status @default(pending)
  subtotal           Decimal       @default(0.00) @db.Decimal(12, 2)
  discount_total     Decimal       @default(0.00) @db.Decimal(12, 2)
  shipping_fee       Decimal       @default(0.00) @db.Decimal(12, 2)
  grand_total        Decimal       @default(0.00) @db.Decimal(12, 2)
  customer_name      String        @db.VarChar(200)
  customer_phone     String        @db.VarChar(30)
  ship_address_line1 String        @db.VarChar(255)
  ship_address_line2 String?       @db.VarChar(255)
  ship_city          String        @db.VarChar(120)
  ship_province      String        @db.VarChar(120)
  ship_postal_code   String?       @db.VarChar(20)
  ship_country       String        @default("VN") @db.VarChar(80)
  note               String?       @db.VarChar(500) // Customer note
  admin_note         String?       @db.VarChar(500) // Internal note
  created_at         DateTime      @default(now())
  updated_at         DateTime?     @updatedAt

  user               users?               @relation(fields: [user_id], references: [id], onDelete: SetNull)
  order_items        order_items[]
  payments           payments[]
  shipments          shipments[]
  coupon_redemptions coupon_redemptions[]

  @@index([user_id], map: "idx_orders_user")
  @@index([status], map: "idx_orders_status")
}

enum orders_status {
  pending
  confirmed
  paid
  processing
  shipped
  completed
  cancelled
  refunded
}

model order_items {
  id           BigInt  @id @default(autoincrement()) @db.UnsignedBigInt
  order_id     BigInt  @db.UnsignedBigInt
  product_id   BigInt  @db.UnsignedBigInt
  variant_id   BigInt  @db.UnsignedBigInt
  sku          String  @db.VarChar(120)
  name         String  @db.VarChar(255)
  options_text String? @db.VarChar(255)
  unit_price   Decimal @db.Decimal(12, 2)
  qty          Int
  line_total   Decimal @db.Decimal(12, 2)

  order   orders           @relation(fields: [order_id], references: [id], onDelete: Cascade)
  product products         @relation(fields: [product_id], references: [id])
  variant product_variants @relation(fields: [variant_id], references: [id])

  @@index([order_id], map: "idx_oi_order")
  @@index([variant_id], map: "idx_oi_variant")
  @@index([product_id], map: "fk_oi_product")
}

// ==================== PAYMENTS ====================

model payments {
  id              BigInt          @id @default(autoincrement()) @db.UnsignedBigInt
  order_id        BigInt          @db.UnsignedBigInt
  method          payments_method
  status          payments_status @default(pending)
  amount          Decimal         @db.Decimal(12, 2)
  transaction_ref String?         @db.VarChar(200)
  paid_at         DateTime?
  created_at      DateTime        @default(now())

  order orders @relation(fields: [order_id], references: [id], onDelete: Cascade)

  @@index([order_id], map: "idx_pay_order")
}

enum payments_method {
  cod
  bank_transfer
  momo
  zalopay
  vnpay
  paypal
  stripe
}

enum payments_status {
  pending
  paid
  failed
  refunded
}

// ==================== SHIPMENTS ====================

model shipments {
  id            BigInt           @id @default(autoincrement()) @db.UnsignedBigInt
  order_id      BigInt           @unique @db.UnsignedBigInt
  carrier       String?          @db.VarChar(100)
  tracking_code String?          @db.VarChar(120)
  status        shipments_status @default(pending)
  shipped_at    DateTime?
  delivered_at  DateTime?
  created_at    DateTime         @default(now())

  order orders @relation(fields: [order_id], references: [id], onDelete: Cascade)
}

enum shipments_status {
  pending
  shipping
  delivered
  returned
  cancelled
}

// ==================== COUPONS ====================

model coupons {
  id             BigInt       @id @default(autoincrement()) @db.UnsignedBigInt
  code           String       @unique @db.VarChar(50)
  type           coupons_type
  value          Decimal      @db.Decimal(12, 2)
  min_subtotal   Decimal      @default(0.00) @db.Decimal(12, 2)
  max_discount   Decimal?     @db.Decimal(12, 2)
  start_at       DateTime?
  end_at         DateTime?
  usage_limit    Int?
  usage_per_user Int?
  is_active      Boolean      @default(true) @db.TinyInt
  created_at     DateTime     @default(now())

  coupon_redemptions coupon_redemptions[]
}

enum coupons_type {
  percent
  fixed
}

model coupon_redemptions {
  id              BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  coupon_id       BigInt   @db.UnsignedBigInt
  user_id         BigInt?  @db.UnsignedBigInt
  order_id        BigInt   @db.UnsignedBigInt
  discount_amount Decimal  @db.Decimal(12, 2)
  created_at      DateTime @default(now())

  coupon coupons @relation(fields: [coupon_id], references: [id])
  user   users?  @relation(fields: [user_id], references: [id], onDelete: SetNull)
  order  orders  @relation(fields: [order_id], references: [id], onDelete: Cascade)

  @@index([coupon_id], map: "idx_cr_coupon")
  @@index([user_id], map: "idx_cr_user")
  @@index([order_id], map: "idx_cr_order")
}

// ==================== INVENTORY ====================

model inventory_movements {
  id         BigInt                   @id @default(autoincrement()) @db.UnsignedBigInt
  variant_id BigInt                   @db.UnsignedBigInt
  type       inventory_movements_type
  qty        Int
  note       String?                  @db.VarChar(255)
  created_at DateTime                 @default(now())

  variant product_variants @relation(fields: [variant_id], references: [id], onDelete: Cascade)

  @@index([variant_id], map: "idx_im_variant")
}

enum inventory_movements_type {
  in
  out
  adjust
}

// ==================== WISHLISTS ====================

model wishlists {
  id         BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  user_id    BigInt   @unique @db.UnsignedBigInt
  created_at DateTime @default(now())

  user           users            @relation(fields: [user_id], references: [id], onDelete: Cascade)
  wishlist_items wishlist_items[]
}

model wishlist_items {
  id          BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  wishlist_id BigInt   @db.UnsignedBigInt
  product_id  BigInt   @db.UnsignedBigInt
  created_at  DateTime @default(now())

  wishlist wishlists @relation(fields: [wishlist_id], references: [id], onDelete: Cascade)
  product  products  @relation(fields: [product_id], references: [id], onDelete: Cascade)

  @@unique([wishlist_id, product_id], map: "uk_wl_item")
  @@index([product_id], map: "idx_wl_product")
}

// ==================== SETTINGS ====================

model settings {
  key        String   @id @db.VarChar(100)
  value      String   @db.Text
  updated_at DateTime @default(now()) @updatedAt
}

// ==================== NOTIFICATIONS ====================

model notifications {
  id          BigInt              @id @default(autoincrement()) @db.UnsignedBigInt
  user_id     BigInt?             @db.UnsignedBigInt
  type        notifications_type
  title       String              @db.VarChar(255)
  message     String              @db.VarChar(500)
  link        String?             @db.VarChar(255) // Admin route to navigate to
  is_read     Boolean             @default(false) @db.TinyInt
  created_at  DateTime            @default(now())
  
  user        users?              @relation(fields: [user_id], references: [id], onDelete: Cascade)
  
  @@index([user_id], map: "idx_notifications_user")
  @@index([is_read], map: "idx_notifications_read")
  @@index([created_at], map: "idx_notifications_created")
}

enum notifications_type {
  order_new
  order_status
  product_low_stock
  product_out_of_stock
  system
}

// ==================== PERMISSIONS ====================

model permissions {
  id          Int      @id @default(autoincrement())
  name        String   @unique @db.VarChar(100)
  description String?  @db.Text
  created_at  DateTime @default(now())
  
  users       users[]
}

// ==================== PRODUCT REVIEWS ====================

model product_reviews {
  id          BigInt    @id @default(autoincrement()) @db.UnsignedBigInt
  product_id  BigInt    @db.UnsignedBigInt
  user_id     BigInt?   @db.UnsignedBigInt
  rating      Int       @default(5) @db.TinyInt // 1-5 stars
  title       String?   @db.VarChar(255)
  content     String?   @db.Text
  author_name String?   @db.VarChar(200) // For guest reviews
  status      review_status @default(pending)
  is_verified Boolean   @default(false) @db.TinyInt // Verified purchase
  helpful_count Int     @default(0)
  created_at  DateTime  @default(now())
  updated_at  DateTime? @updatedAt

  product     products  @relation(fields: [product_id], references: [id], onDelete: Cascade)

  @@index([product_id], map: "idx_reviews_product")
  @@index([status], map: "idx_reviews_status")
}

enum review_status {
  pending
  approved
  rejected
  hidden
}

// ==================== SHIPPING METHODS ====================

model shipping_methods {
  id          BigInt    @id @default(autoincrement()) @db.UnsignedBigInt
  name        String    @db.VarChar(200)
  code        String    @unique @db.VarChar(50)
  description String?   @db.Text
  base_fee    Decimal   @default(0.00) @db.Decimal(12, 2)
  fee_per_kg  Decimal   @default(0.00) @db.Decimal(12, 2) // Extra fee per kg
  min_days    Int       @default(1) // Estimated delivery min days
  max_days    Int       @default(3) // Estimated delivery max days
  provinces   String?   @db.Text // JSON array of supported provinces, null = all
  is_active   Boolean   @default(true) @db.TinyInt
  sort_order  Int       @default(0)
  created_at  DateTime  @default(now())
  updated_at  DateTime? @updatedAt

  @@index([is_active], map: "idx_shipping_active")
}

// ==================== BANNERS ====================

model banners {
  id          BigInt    @id @default(autoincrement()) @db.UnsignedBigInt
  title       String    @db.VarChar(255)
  subtitle    String?   @db.VarChar(500)
  image_url   String    @db.VarChar(1000)
  link_url    String?   @db.VarChar(1000)
  button_text String?   @db.VarChar(100)
  position    String    @default("home_hero") @db.VarChar(50) // home_hero, home_promo, category_top
  sort_order  Int       @default(0)
  is_active   Boolean   @default(true) @db.TinyInt
  start_date  DateTime? // Schedule start
  end_date    DateTime? // Schedule end
  created_at  DateTime  @default(now())
  updated_at  DateTime? @updatedAt

  banner_images banner_images[]

  @@index([position, is_active], map: "idx_banners_position")
}

model banner_images {
  id        BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  banner_id BigInt   @db.UnsignedBigInt
  image_url String   @db.VarChar(1000)
  sort_order Int     @default(0)
  created_at DateTime @default(now())

  banner    banners  @relation(fields: [banner_id], references: [id], onDelete: Cascade)

  @@index([banner_id], map: "idx_bi_banner")
}

// ==================== ACTIVITY LOGS ====================

model activity_logs {
  id          BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  user_id     BigInt?  @db.UnsignedBigInt
  action      String   @db.VarChar(100) // create, update, delete, login, export
  entity_type String?  @db.VarChar(100) // product, order, user, system
  entity_id   String?  @db.VarChar(100)
  details     String?  @db.Text // JSON details of change
  ip_address  String?  @db.VarChar(45)
  user_agent  String?  @db.VarChar(255)
  created_at  DateTime @default(now())

  user        users?   @relation(fields: [user_id], references: [id], onDelete: SetNull)

  @@index([user_id], map: "idx_logs_user")
  @@index([action], map: "idx_logs_action")
  @@index([created_at], map: "idx_logs_date")
}

// ==================== SUPPORT CHAT ====================

model conversations {
  id          BigInt              @id @default(autoincrement()) @db.UnsignedBigInt
  user_id     BigInt?             @db.UnsignedBigInt
  guest_name  String?             @db.VarChar(200) // For guest users
  guest_email String?             @db.VarChar(255)
  status      conversation_status @default(waiting)
  assigned_to BigInt?             @db.UnsignedBigInt // Admin/Staff handling this
  created_at  DateTime            @default(now())
  updated_at  DateTime?           @updatedAt
  closed_at   DateTime?
  
  user        users?              @relation(fields: [user_id], references: [id], onDelete: SetNull)
  messages    chat_messages[]

  @@index([user_id], map: "idx_conv_user")
  @@index([status], map: "idx_conv_status")
  @@index([assigned_to], map: "idx_conv_assigned")
}

enum conversation_status {
  waiting    // Waiting for admin
  active     // Admin is chatting
  closed     // Conversation ended
}

model chat_messages {
  id              BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  conversation_id BigInt   @db.UnsignedBigInt
  sender_type     sender_type @default(user)
  sender_id       BigInt?  @db.UnsignedBigInt // user_id or admin_id
  content         String   @db.Text
  is_read         Boolean  @default(false) @db.TinyInt
  created_at      DateTime @default(now())

  conversation    conversations @relation(fields: [conversation_id], references: [id], onDelete: Cascade)

  @@index([conversation_id], map: "idx_msg_conv")
  @@index([sender_id], map: "idx_msg_sender")
}

enum sender_type {
  user
  admin
  system
}
